(function(a){a.fn.juke=function(b){b=a.extend({},a.fn.juke.option,b);var c=function(a){if(a.length===0)return!1;a=a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@");a=a.replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]");a=a.replace(/(?:^|:|,)(?:\s*\[)+/g,"");return/^[\],:{}\s]*$/.test(a)},d=function(){return"ontouchstart"in window};return this.each(function(){var e,f,g,h=!1,i=1,j,k,l,m=0,n,o,p=document.title,q,r,s=a(this),t,u,v,w,x,y=a("#juke").width()/2-62;window.onresize=function(){v.css({right:v.parent().width()/2+63});w.css({left:w.parent().width()/2+64});y=a("#juke").width()/2-62;a(".filler").width(y);x=t.parent().width()/2-62;m>0&&(x-=y+i*125);t.css({left:x})};var z=function(a){var b=r[a].marker,c=/:/,d=/^\d*(?=:)/,e=/[0-5][0-9]$/,f,g;if(c.test(b)){f=parseInt(d.exec(b),10);g=parseInt(e.exec(b),10);return f*60+g}return parseInt(r[a].marker,10)};c(b.trackinfo)?r=a.parseJSON(b.trackinfo):r=function(){var c=null;a.ajax({async:!1,global:!1,url:b.trackinfo,dataType:"json",success:function(a){c=a}});return c}();o=parseInt(r.duration,10);r=r.tracks;j=z(i-1);k=z(i);l=parseInt(r.length,10);s.children().wrapAll('<ul id="tapebox"/>');a("#tapebox").wrapAll('<div id="displaybox"/>');a("#tapebox").prepend('<li><img src="'+b.placeholder+'" width="125"></li><li class="filler">&nbsp;</li>');a("#displaybox").prepend('<img src="'+b.imagesFolder+'bg.png" alt="">');s.prepend('<div id="shadowleft" class="shadow"></div><div id="shadowright" class="shadow"></div><div id="playhead"><img src="'+b.imagesFolder+'playhead_overlay.png"><div id="playtoggle" class="hover"></div></div>');s.append('<div id="displaybox_overlay"><img src="'+b.imagesFolder+'displaybox_overlay.png" /></div>');b.tooltips&&a("#playhead").append('<div class="tooltip">'+b.title+"</div>");b.debug&&a("#juke").append('<span id="skipbackward">REV</span>&nbsp;-&nbsp;<span id="skipforward">FWD</span>');v=a("#shadowleft");w=a("#shadowright");t=a("#tapebox");u=a("#playtoggle");if(soundManager){soundManager.url=b.soundmanagerFolder+"soundmanager2_flash_xdomain/";soundManager.useHTML5Audio=!0;soundManager.useFlashBlock=!0;soundManager.consoleOnly=!0;soundManager.debugMode=b.debug;soundManager.wmode="transparent";soundManager.onready(function(){var c=soundManager.createSound({id:"juke",url:a.trim(b.audio),autoLoad:!0,onplay:function(){u.addClass("playing");document.title="â–¶ "+b.title+" - "+p;if(m===0){x=t.parent().width()/2-62-y-125;t.animate({left:x},b.animationSpeed,"swing");b.tooltips&&a(".tooltip").html("<p>"+r[i-1].artist+"</p><em class='track'>"+r[i-1].track+"</em>")}},onpause:function(){u.removeClass("playing");document.title=p},onfinish:function(){u.removeClass("playing");document.title=p},whileplaying:function(){m=parseInt(soundManager.getSoundById("juke").position/1e3,10);m>=o&&soundManager.pause("juke");if(m>=k){while(m>=k){i++;if(!(i<l)){k=o;break}j=k;k=z(i)}if(i<=l){t.animate({left:"-=125px"},b.animationSpeed,"swing");b.tooltips&&a(".tooltip").html("<p>"+r[i-1].artist+"</p><em class='track'>"+r[i-1].track+"</em>")}}b.debug&&console.log("total: "+o+", currently at: "+m+", next marker: "+k)}});a("#playtoggle").click(function(){soundManager.togglePause("juke")});if(b.debug){a("#skipforward").click(function(){soundManager.getSoundById("juke").setPosition(soundManager.getSoundById("juke").position+5e3)});a("#skipbackward").click(function(){soundManager.getSoundById("juke").setPosition(soundManager.getSoundById("juke").position-5e3)})}b.tooltips&&!d()&&a("#playhead").hover(function(){a(".tooltip").fadeIn(100)},function(){a(".tooltip").fadeOut(100)});a(".filler").width(y);v.css({right:v.parent().width()/2+63});w.css({left:w.parent().width()/2+64});t.css({left:t.parent().width()/2-62});a("#juke").css("visibility","visible")})}else b.debug&&console.log("Juke can't see the required SoundManager 2 object.")})};a.fn.juke.option={title:"Mixtape",imagesFolder:"public/images/juke/",soundmanagerFolder:"public/swf/",placeholder:"images/juke/default.jpg",trackinfo:"trackinfo.json",audio:"mix.mp3",tooltips:!1,animationSpeed:400,debug:!1}})(jQuery);