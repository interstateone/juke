(function(a){a.fn.juke=function(b){b=a.extend({},a.fn.juke.option,b);var c=function(a){if(a.length===0)return!1;a=a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@");a=a.replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]");a=a.replace(/(?:^|:|,)(?:\s*\[)+/g,"");return/^[\],:{}\s]*$/.test(a)},d=function(){return"ontouchstart"in window};return this.each(function(){var d,e,f,g=!1,h=1,i,j,k,l=0,m,n,o=document.title,p,q,r=a(this),s,t,u,v,w,x;window.onresize=function(){u.css({right:u.parent().width()/2+63});v.css({left:v.parent().width()/2+64});x=s.parent().width()/2-62;l>0&&(x-=+h*125);s.css({left:x})};var y=function(a){var b=q[a].marker,c=/:/,d=/^\d*(?=:)/,e=/[0-5][0-9]$/,f,g;if(c.test(b)){f=parseInt(d.exec(b),10);g=parseInt(e.exec(b),10);return f*60+g}return parseInt(q[a].marker,10)},z=function(c,d){var e=c+" &dash; <em class='track'>"+d+"</em>",f,g,h;b.itunes?a.ajax({url:"http://api.wipmania.com/jsonp?callback=?",dataType:"jsonp",success:function(b){f=b.address.country_code;g="http://itunes.apple.com/search?entity=song&country="+f+"&term="+encodeURIComponent(c+" "+d)+"&limit=5&callback=?";a.getJSON(g,function(b){b.resultCount===1?h=b.results[0].trackViewUrl:b.resultCount>1?a.each(b.results,function(){this.trackName===d&&(h=this.trackViewUrl)}):h=null;h!==null&&(e+=" (<a href='"+h+"' class='itunes-link'>iTunes</a>)");w.html(e)})}}):w.html(e)};c(b.trackinfo)?q=a.parseJSON(b.trackinfo):q=function(){var c=null;a.ajax({async:!1,global:!1,url:b.trackinfo,dataType:"json",success:function(a){c=a}});return c}();n=parseInt(q.duration,10);q=q.tracks;i=y(h-1);j=y(h);k=parseInt(q.length,10);r.children().wrapAll('<ul id="tapebox"/>');a("#tapebox").wrapAll('<div id="displaybox"/>');a("#tapebox").prepend('<li><img src="'+b.placeholder+'" width="125"></li>');a("#displaybox").prepend('<img src="'+b.imagesFolder+'bg.png" alt="">');r.prepend('<div id="shadowleft" class="shadow"></div><div id="shadowright" class="shadow"></div><div id="playhead"><img src="'+b.imagesFolder+'playhead_overlay.png"><div id="playtoggle" class="hover"></div></div>');r.append('<div id="displaybox_overlay"><img src="'+b.imagesFolder+'displaybox_overlay.png" /></div>');if(b.tooltips){a("#juke").append('<div class="tooltip">'+b.title+"</div>");w=a(".tooltip")}b.debug&&a("#juke").append('<span id="skipbackward">REV</span>&nbsp;-&nbsp;<span id="skipforward">FWD</span>');u=a("#shadowleft");v=a("#shadowright");s=a("#tapebox");t=a("#playtoggle");if(soundManager){soundManager.url=b.soundmanagerFolder+"soundmanager2_flash_xdomain/";soundManager.useHTML5Audio=!0;soundManager.autoLoad=!0;soundManager.preferFlash=!1;soundManager.consoleOnly=!0;soundManager.debugMode=b.debug;soundManager.wmode="transparent";soundManager.onready(function(){var c=soundManager.createSound({id:"juke",url:a.trim(b.audio),onplay:function(){t.addClass("playing");document.title="â–¶ "+b.title+" - "+o;if(l===0){x=s.parent().width()/2-62-125;s.animate({left:x},b.animationSpeed,"swing");b.tooltips&&z(q[h-1].artist,q[h-1].track)}},onpause:function(){t.removeClass("playing");document.title=o},onfinish:function(){t.removeClass("playing");document.title=o},whileplaying:function(){l=parseInt(soundManager.getSoundById("juke").position/1e3,10);l>=n&&soundManager.pause("juke");if(l>=j){while(l>=j){h++;if(!(h<k)){j=n;break}i=j;j=y(h)}if(h<=k){s.animate({left:"-=125px"},b.animationSpeed,"swing");b.tooltips&&z(q[h-1].artist,q[h-1].track)}}b.debug&&console.log("total: "+n+", currently at: "+l+", next marker: "+j)}});a("#playtoggle").click(function(){soundManager.togglePause("juke")});if(b.debug){a("#skipforward").click(function(){soundManager.getSoundById("juke").setPosition(soundManager.getSoundById("juke").position+5e3)});a("#skipbackward").click(function(){soundManager.getSoundById("juke").setPosition(soundManager.getSoundById("juke").position-5e3)})}u.css({right:u.parent().width()/2+63});v.css({left:v.parent().width()/2+64});s.css({left:s.parent().width()/2-62});a("#juke").css("visibility","visible")})}else b.debug&&console.log("Juke can't see the required SoundManager 2 object.")})};a.fn.juke.option={title:"Mixtape",imagesFolder:"public/images/juke/",soundmanagerFolder:"public/swf/",placeholder:"images/juke/default.jpg",trackinfo:"trackinfo.json",itunes:!0,audio:"mix.mp3",tooltips:!1,animationSpeed:400,debug:!1}})(jQuery);